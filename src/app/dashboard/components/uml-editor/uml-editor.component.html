<!-- uml-editor.component.html -->
<p-toast key="br" position="bottom-right"></p-toast>
<p-confirmDialog></p-confirmDialog>
<div class="control-section">
  <!-- Header con botones -->
  <div class="uml-header bg-white dark:bg-slate-900 border-b border-gray-200 dark:border-slate-700">
    <div class="flex items-center gap-2">
      <h2 class="text-lg font-semibold flex-1 text-slate-900 dark:text-slate-100">
        {{project?.name}}
        <span *ngIf="hasUnsavedChanges" class="ml-2 text-orange-500 text-sm">● Cambios no guardados</span>
      </h2>
      <button class="btn btn-primary" (click)="addNewClass()">+ Clase</button>
      <!-- <button class="btn btn-success" (click)="addMethod()">+ étodo</button> -->
      <button class="btn btn-warning" (click)="addAttribute()">+ Atributo</button>
      <button class="btn btn-info" (click)="autolayout()">Autolayout</button>
      <button class="btn btn-success" (click)="saveProject()">Guardar</button>
      <button class="btn" (click)="logJson()">Ver JSON</button>
      <!-- Botón Exportar con menú mejorado -->
      <div class="relative">
        <p-menu 
          #exportMenu 
          [popup]="true" 
          [model]="exportMenuItems"
          [appendTo]="'body'"
          [baseZIndex]="1200"
          styleClass="min-w-48"
        ></p-menu>
        <p-button 
          label="Exportar" 
          icon="pi pi-download" 
          severity="info"
          (onClick)="exportMenu.toggle($event)"
          [text]="true"
        ></p-button>
      </div>
      <button class="btn btn-danger" (click)="closeEditor()">Cerrar</button>
    </div>
  </div>

  
  <!-- Área principal del diagrama -->
  <div class="editor-content">
    <div class="sb-mobile-palette">
      <h4 style="text-align: center; padding: 10px; margin: 0; background: #f5f5f5; border-bottom: 1px solid #e0e0e0;">
        UML Shapes
      </h4>
      <ejs-symbolpalette 
        id="symbolpalette" 
        [expandMode]="expandMode" 
        [palettes]="palettes" 
        [getSymbolInfo]="getSymbolInfo" 
        width="100%" 
        height="calc(100% - 50px)" 
        [symbolHeight]="90"
        [symbolWidth]="90" 
        [symbolMargin]="symbolMargin" 
        [getNodeDefaults]="getSymbolDefaults">
      </ejs-symbolpalette>
    </div>
    
    <div class="sb-mobile-diagram">
      <ejs-diagram 
         #diagram
        id="diagram"
        width="100%" height="100%"
        [getNodeDefaults]="getNodeDefaults"
        [getConnectorDefaults]="getConnectorDefaults"
        [setNodeTemplate]="setNodeTemplate"
        [nodes]="nodes" [connectors]="connectors"
        (created)="created()"
        (dragEnter)="dragEnter($event)"
        (selectionChange)="onSelectionChange($event)"
        (collectionChange)="onDiagramChange($event)"
        (propertyChange)="onDiagramChange($event)"
        (positionChange)="onDiagramChange($event)"
        (rotateChange)="onDiagramChange($event)"
        (sizeChange)="onDiagramChange($event)"
        (connectionChange)="onDiagramChange($event)"
        (sourcePointChange)="onDiagramChange($event)"
        (targetPointChange)="onDiagramChange($event)"
        (textEdit)="onDiagramChange($event)">
      </ejs-diagram>
      <!-- <ejs-overview id="overview" sourceID="diagram" style="width:300px;height:180px"></ejs-overview> -->
    </div>
  </div>
</div>

<!-- Diálogo para cambios sin guardar -->
<app-unsaved-changes-dialog 
  [(visible)]="showUnsavedDialog"
  (result)="onUnsavedChangesResult($event)"
></app-unsaved-changes-dialog>

<!-- AI Chat Assistant -->
<app-ai-chat 
  [projectId]="projectId" 
  (diagramAction)="handleAIAction($event)">
</app-ai-chat>