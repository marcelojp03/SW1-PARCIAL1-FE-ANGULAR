<!-- uml-editor.component.html -->
<p-toast key="br" position="bottom-right"></p-toast>
<p-confirmDialog></p-confirmDialog>
<div class="control-section">
  <!-- Header con botones -->
  <div class="uml-header bg-white dark:bg-slate-900 border-b border-gray-200 dark:border-slate-700">
    <div class="flex items-center gap-2">
      <h2 class="text-lg font-semibold flex-1 text-slate-900 dark:text-slate-100">
        Editor de Diagramas de Clase UML
        <span *ngIf="hasUnsavedChanges" class="ml-2 text-orange-500 text-sm">● Cambios no guardados</span>
      </h2>
      <button class="btn btn-primary" (click)="addNewClass()">+ Clase</button>
      <!-- <button class="btn btn-success" (click)="addMethod()">+ étodo</button> -->
      <button class="btn btn-warning" (click)="addAttribute()">+ Atributo</button>
      <button class="btn btn-info" (click)="autolayout()">Autolayout</button>
      <button class="btn btn-success" (click)="saveProject()">Guardar</button>
      <button class="btn" (click)="logJson()">Ver JSON</button>
      <!-- Botón Exportar con menú -->
        <div class="relative" (mouseleave)="showExportMenu=false">
            <button class="btn btn-info" (click)="showExportMenu = !showExportMenu">Exportar ▾</button>
            <div *ngIf="showExportMenu"
                class="absolute right-0 mt-2 w-56 bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-lg shadow z-50">
                <button class="w-full text-left px-4 py-2 hover:bg-gray-50 dark:hover:bg-slate-700"
                        (click)="exportImage('PNG'); showExportMenu=false">Imagen PNG</button>
                <button class="w-full text-left px-4 py-2 hover:bg-gray-50 dark:hover:bg-slate-700"
                        (click)="exportImage('SVG'); showExportMenu=false">Imagen SVG</button>
                <div class="border-t border-gray-200 dark:border-slate-700 my-1"></div>
                <button class="w-full text-left px-4 py-2 hover:bg-gray-50 dark:hover:bg-slate-700"
                        (click)="exportToSpringBoot(); showExportMenu=false">Spring Boot (.zip)</button>
            </div>
        </div>
      <button class="btn btn-danger" (click)="closeEditor()">Cerrar</button>
    </div>
  </div>

  
  <!-- Área principal del diagrama -->
  <div class="editor-content">
    <div class="sb-mobile-palette">
      <h4 style="text-align: center; padding: 10px; margin: 0; background: #f5f5f5; border-bottom: 1px solid #e0e0e0;">
        UML Shapes
      </h4>
      <ejs-symbolpalette 
        id="symbolpalette" 
        [expandMode]="expandMode" 
        [palettes]="palettes" 
        [getSymbolInfo]="getSymbolInfo" 
        width="100%" 
        height="calc(100% - 50px)" 
        [symbolHeight]="90"
        [symbolWidth]="90" 
        [symbolMargin]="symbolMargin" 
        [getNodeDefaults]="getSymbolDefaults">
      </ejs-symbolpalette>
    </div>
    
    <div class="sb-mobile-diagram">
      <ejs-diagram 
         #diagram
        id="diagram"
        width="100%" height="100%"
        [getNodeDefaults]="getNodeDefaults"
        [getConnectorDefaults]="getConnectorDefaults"
        [setNodeTemplate]="setNodeTemplate"
        [nodes]="nodes" [connectors]="connectors"
        (created)="created()"
        (dragEnter)="dragEnter($event)"
        (selectionChange)="onSelectionChange($event)"
        (collectionChange)="onDiagramChange($event)"
        (propertyChange)="onDiagramChange($event)"
        (positionChange)="onDiagramChange($event)"
        (rotateChange)="onDiagramChange($event)"
        (sizeChange)="onDiagramChange($event)"
        (connectionChange)="onDiagramChange($event)"
        (sourcePointChange)="onDiagramChange($event)"
        (targetPointChange)="onDiagramChange($event)"
        (textEdit)="onDiagramChange($event)">
      </ejs-diagram>
      <!-- <ejs-overview id="overview" sourceID="diagram" style="width:300px;height:180px"></ejs-overview> -->
    </div>
  </div>
</div>

<!-- Diálogo para cambios sin guardar -->
<app-unsaved-changes-dialog 
  [(visible)]="showUnsavedDialog"
  (result)="onUnsavedChangesResult($event)"
></app-unsaved-changes-dialog>